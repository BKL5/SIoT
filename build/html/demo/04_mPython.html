
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="go">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>4. 掌控板（mPython） &#8212; SIoT使用手册 1.0 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="5. Arduino+OBloq" href="05_Arduino.html" />
    <link rel="prev" title="3. Mind plus" href="03_Mindplus.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="mpython">
<h1>4. 掌控板（mPython）<a class="headerlink" href="#mpython" title="Permalink to this headline">¶</a></h1>
<div class="section" id="id1">
<h2>4.1. 掌控板介绍<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div>掌控板由虚谷计划组委会推出，是国内第一款专为编程教育而设计的开源硬件！为普及创客教育而生，反应一线Python编程教学需求，迎接普通高中新课改。</div></blockquote>
<p>掌控板委托创客教育知名品牌Labplus盛思设计、制造与发行，历经十几轮次研究讨论，三次升级改版，是国内第一款专为编程教育而设计的开源硬件！
掌控板上集成了OLED显示屏、RGB灯、加速度计、麦克风、光线传感器、蜂鸣器、按键开关、触摸开关、金手指外部拓展接口，支持图形化及python代码编程，可实现智能机器人、创客智造作品等智能控制类应用。</p>
<p>利用掌控板上丰富的传感器，结合它小尺寸的特点还可以做很多智能穿戴、电子饰品等各种DIY作品应用。</p>
<p>掌控板地址：<a class="reference external" href="https://mpython.cn/mPython/index">https://mpython.cn/mPython/index</a></p>
</div>
<div class="section" id="id2">
<h2>4.2. 掌控板的编程工具介绍<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>掌控板的编程工具很多，常用的有：</p>
<blockquote>
<div><ul class="simple">
<li>mPython X</li>
<li>Mind +</li>
<li>Mixly</li>
<li>BXY</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="mqtt-mind">
<h2>4.3. 掌控板的MQTT代码（基于Mind+）<a class="headerlink" href="#mqtt-mind" title="Permalink to this headline">¶</a></h2>
<p>Mind+是一款基于Scratch3.0开发的青少年编程软件，让大家轻松体验创造的乐趣。</p>
<p><cite>网站：http://mindplus.cc/</cite></p>
<p><strong>发送消息</strong></p>
<img alt="../_images/Mind+Mqtt-01.png" src="../_images/Mind+Mqtt-01.png" />
<p><strong>订阅消息</strong></p>
<img alt="../_images/Mind+Mqtt-02.png" src="../_images/Mind+Mqtt-02.png" />
</div>
<div class="section" id="mqtt-bxy">
<h2>4.4. 掌控板的MQTT代码（基于BXY）<a class="headerlink" href="#mqtt-bxy" title="Permalink to this headline">¶</a></h2>
<p>BXY是一款运行于Windows平台的MicroPython编程IDE，界面简洁，操作便利。BXY是浙教版普通高中信息技术教材的为众多micro:bit和掌控板爱好者提供了一个简洁实用的平台。</p>
<p>下载地址：<a class="reference external" href="http://docs.dfrobot.com.cn/bxy/">http://docs.dfrobot.com.cn/bxy/</a></p>
<p><strong>代码说明：</strong></p>
<p>这个实验需要2个掌控板，一个发布光线数据一个订阅光线数据，MQTT服务器既可以用EasyIot物联网，也可以用SIoT。</p>
<p><strong>注意</strong>：使用BXY下载下面的代码，还需要另外添加一个库文件Iot.py。本代码已经整合在BXY的范例中，将BXY升级到最新即可看到。</p>
<p>代码下载链接：<a class="reference external" href="https://github.com/vvlink/SIoT/tree/master/examples/%E6%8E%8C%E6%8E%A7%E6%9D%BF%E4%BB%A3%E7%A0%81/Bxy">https://github.com/vvlink/SIoT/tree/master/examples/%E6%8E%8C%E6%8E%A7%E6%9D%BF%E4%BB%A3%E7%A0%81/Bxy</a></p>
<p><strong>发送消息</strong></p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># 功能：发布光线数据</span>
<span class="kn">from</span> <span class="nn">mpython</span> <span class="k">import</span> <span class="n">light</span>
<span class="kn">from</span> <span class="nn">Iot</span> <span class="k">import</span> <span class="n">Iot</span>
<span class="kn">from</span> <span class="nn">umqtt.simple</span> <span class="k">import</span> <span class="n">MQTTClient</span>
<span class="kn">from</span> <span class="nn">machine</span> <span class="k">import</span> <span class="n">Timer</span>
<span class="kn">import</span> <span class="nn">machine</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">network</span>

<span class="n">WIFI_SSID</span> <span class="o">=</span> <span class="s1">&#39;yourSSID&#39;</span><span class="c1">#替换成你的WIFI热点名称</span>
<span class="n">WIFI_PASSWORD</span> <span class="o">=</span> <span class="s1">&#39;yourPASSWD&#39;</span><span class="c1">#替换成你的WIFI热点密码</span>

<span class="n">IOT_SERVER</span> <span class="o">=</span> <span class="s2">&quot;server address&quot;</span> <span class="c1">#EASYIOT的服务器为iot.dfrobot.com.cn；Siot地址为用户搭建的服务器的ip地址，例如：192.168.0.100</span>
<span class="n">IOT_PORT</span> <span class="o">=</span> <span class="mi">1883</span>
<span class="n">IOT_ClientID</span> <span class="o">=</span> <span class="s2">&quot;your ClientID&quot;</span><span class="c1">#替换成你的ClientID，可为空</span>
<span class="n">IOT_UserName</span> <span class="o">=</span> <span class="s2">&quot;your UserName&quot;</span><span class="c1">#替换成你的UserName</span>
<span class="n">IOT_PassWord</span> <span class="o">=</span> <span class="s2">&quot;your PassWord&quot;</span><span class="c1">#替换成你的PassWord</span>
<span class="n">IOT_pubTopic</span> <span class="o">=</span> <span class="s1">&#39;your PubTopic&#39;</span> <span class="c1">#如果是siot，自定义的topic中需要添加&quot;/&quot;，例如:&quot;abc/abc&quot;</span>

<span class="n">myIot</span> <span class="o">=</span> <span class="n">Iot</span><span class="p">(</span><span class="n">IOT_SERVER</span><span class="p">,</span> <span class="n">IOT_UserName</span><span class="p">,</span> <span class="n">IOT_ClientID</span><span class="p">,</span> <span class="n">IOT_PassWord</span><span class="p">)</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">MQTTClient</span><span class="p">(</span><span class="n">myIot</span><span class="o">.</span><span class="n">client_id</span><span class="p">,</span> <span class="n">myIot</span><span class="o">.</span><span class="n">mqttserver</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">IOT_PORT</span><span class="p">,</span> <span class="n">user</span> <span class="o">=</span> <span class="n">myIot</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="n">myIot</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>

<span class="n">tim1</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">connectWIFI</span><span class="p">():</span>
  <span class="n">station</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">WLAN</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">STA_IF</span><span class="p">)</span>
  <span class="n">station</span><span class="o">.</span><span class="n">active</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">station</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">WIFI_SSID</span><span class="p">,</span><span class="n">WIFI_PASSWORD</span><span class="p">)</span>
  <span class="k">while</span> <span class="n">station</span><span class="o">.</span><span class="n">isconnected</span><span class="p">()</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
    <span class="k">pass</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Connection successful&#39;</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">station</span><span class="o">.</span><span class="n">ifconfig</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">restart</span><span class="p">():</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
  <span class="n">machine</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="n">_</span><span class="p">):</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">client</span><span class="o">.</span><span class="n">check_msg</span><span class="p">()</span>
    <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;light&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">light</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
    <span class="n">client</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">IOT_pubTopic</span><span class="p">,</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
    <span class="n">lastTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
  <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">tim1</span><span class="o">.</span><span class="n">deinit</span><span class="p">()</span>
    <span class="n">restart</span><span class="p">()</span>

<span class="n">connectWIFI</span><span class="p">()</span>
<span class="n">client</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

<span class="n">tim1</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">Timer</span><span class="o">.</span><span class="n">PERIODIC</span><span class="p">,</span><span class="n">callback</span><span class="o">=</span><span class="n">check</span><span class="p">)</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
  <span class="k">pass</span>
</pre></div>
</div>
<p><strong>订阅消息</strong></p>
<dl class="docutils">
<dt>::</dt>
<dd><p class="first"># 功能：订阅光线数据
from mpython import *
from Iot import Iot
from umqtt.simple import MQTTClient
from machine import Timer
from machine import Pin
import machine
import time
import json
import network</p>
<p>WIFI_SSID = 'yourSSID'#替换成你的WIFI热点名称
WIFI_PASSWORD = 'yourPASSWD'#替换成你的WIFI热点密码</p>
<p>IOT_SERVER = &quot;server address&quot; #EASYIOT的服务器为iot.dfrobot.com.cn；Siot地址为用户搭建的服务器的ip地址，例如：192.168.0.100
IOT_PORT = 1883
IOT_ClientID = &quot;your ClientID&quot;#替换成你的ClientID，可为空
IOT_UserName = &quot;your UserName&quot;#替换成你的UserName
IOT_PassWord = &quot;your PassWord&quot;#替换成你的PassWord
IOT_subTopic = 'your SubTopic' #如果是siot，自定义的topic中需要添加&quot;/&quot;，例如:&quot;abc/abc&quot;</p>
<p>myIot = Iot(IOT_SERVER, IOT_UserName, IOT_ClientID, IOT_PassWord)
client = MQTTClient(myIot.client_id, myIot.mqttserver, port = IOT_PORT, user = myIot.username, password = myIot.password)</p>
<p>tim1 = Timer(1)</p>
<dl class="docutils">
<dt>def connectWIFI():</dt>
<dd><p class="first">station = network.WLAN(network.STA_IF)
station.active(True)
station.connect(WIFI_SSID,WIFI_PASSWORD)
while station.isconnected() == False:</p>
<blockquote>
<div>pass</div></blockquote>
<p class="last">print('Connection successful')
print(station.ifconfig())</p>
</dd>
<dt>def sub_cb(topic,msg):</dt>
<dd><p class="first">print((topic,msg))
if topic == b'light':</p>
<blockquote>
<div><dl class="docutils">
<dt>try:</dt>
<dd>print(type(msg))
print(&quot;msg=%s&quot;%str(msg))
light= json.loads(msg)[&quot;light&quot;]
oled.DispChar(&quot;接收到对方光强度&quot;,0,0)
oled.DispChar(&quot;%s&quot;%str(light),64,16)
oled.show()
oled.fill(0)
v=light//16
rgb[0] = (v,v,v)
rgb[1] = (v,v,v)
rgb[2] = (v,v,v)
rgb.write()</dd>
<dt>except:</dt>
<dd>print(&quot;error msg:%s&quot;%msg)</dd>
</dl>
</div></blockquote>
<dl class="last docutils">
<dt>else:</dt>
<dd>print(&quot;other topic=%s msg=%s&quot;%(topic,msg))</dd>
</dl>
</dd>
<dt>def restart():</dt>
<dd>time.sleep(10)
machine.reset()</dd>
<dt>def check(_):</dt>
<dd><dl class="first last docutils">
<dt>try:</dt>
<dd>client.check_msg()</dd>
<dt>except OSError as e:</dt>
<dd>tim1.deinit()
restart()</dd>
</dl>
</dd>
</dl>
<p>oled.DispChar(&quot;正在连接网络...&quot;,0,0)
oled.show()
oled.fill(0)
connectWIFI()</p>
<p>client.set_callback(sub_cb)
client.connect()
client.subscribe(IOT_subTopic)</p>
<p>tim1.init(period=1000, mode=Timer.PERIODIC,callback=check)</p>
<dl class="last docutils">
<dt>while True:</dt>
<dd>pass</dd>
</dl>
</dd>
</dl>
</div>
<div class="section" id="mqtt-mpythonx">
<h2>4.5. 掌控板的MQTT代码（基于mPythonX）<a class="headerlink" href="#mqtt-mpythonx" title="Permalink to this headline">¶</a></h2>
<p><strong>发送消息</strong></p>
<p><strong>订阅消息</strong></p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">SIoT使用手册</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../about/index.html">简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../setup/index.html">安装和运行</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">客户端连接范例</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="01_tool.html">1. 常见MQTT客户端</a></li>
<li class="toctree-l2"><a class="reference internal" href="02_Node-RED.html">2. Node-RED</a></li>
<li class="toctree-l2"><a class="reference internal" href="03_Mindplus.html">3. Mind plus</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">4. 掌控板（mPython）</a></li>
<li class="toctree-l2"><a class="reference internal" href="05_Arduino.html">5. Arduino+OBloq</a></li>
<li class="toctree-l2"><a class="reference internal" href="06_microbit.html">6. micro:bit+OBloq</a></li>
<li class="toctree-l2"><a class="reference internal" href="07_Appinventor.html">7. App Inventor2</a></li>
<li class="toctree-l2"><a class="reference internal" href="08_Python.html">8. Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="09_Processing.html">9. Processing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../example/index.html">典型应用案例</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/index.html">高级操作技巧</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">客户端连接范例</a><ul>
      <li>Previous: <a href="03_Mindplus.html" title="previous chapter">3. Mind plus</a></li>
      <li>Next: <a href="05_Arduino.html" title="next chapter">5. Arduino+OBloq</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, VVlink.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="../_sources/demo/04_mPython.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>